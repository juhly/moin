---
title: "Modeling Spatial Interactions (SE Turkey)"
author:
  - Daniel Knitter  
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
    bookdown::html_document2:
    fig_caption: yes
    reference_docx: templates/template.docx
bibliography: references.bib
csl: journal-of-archaeological-science.csl
abstract: |
  Text of abstract
keywords: |
  keyword 1; keyword 2; keyword 3
highlights: |
  These are the highlights. 
---


<!-- This is the format for text comments that will be ignored during renderings. Do not put R code in these comments because it will not be ignored. -->

```{r, setup, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  comment = "#>",
  fig.path = "figures"
)

library(moin)
```

# Ideas to be put in analyses

- use data from Harran plain
- use size of settlements
- create network of sites 
- calculate centrality parameters based on network
- use centrality parameter as "attractiveness"
- use size as "Oi" parameter
- create nice graphs and maps based on that. 

Question: Is the network location mirrored in the size of a settlement? This can be analyzed because the singly-constrained gravity model (also in the entropy maximization case) can be seen as a location model. The more flows that are attracted, the more important is a site

# Analyses

## Load Data

```{r load}
library(magrittr)
library(rgdal)
library(rgeos)

harran <- readOGR(dsn = "../data/raw_data",
                  layer = "harran_plain") %>%
  spTransform(CRSobj = "+init=epsg:32634")

tellpoly <- readOGR(dsn = "../data/raw_data",
                    layer = "settlements") %>%
  spTransform(CRSobj = "+init=epsg:32634")
tellpoly@data$area <- gArea(tellpoly, byid = TRUE)
tellpoly <- tellpoly[harran,]

tellpoints <- tellpoly %>%
  gCentroid(byid=TRUE) %>%
  SpatialPointsDataFrame(data = data.frame(x = .@coords[,1],
                                           y = .@coords[,2],
                                           Tell = tellpoly@data$Tell))

library(mapview)
mapview(harran) + mapview(tellpoly) + mapview(tellpoints)
```

## Create Delaunay Graph and calculate the distances between the connected points

```{r del}
library(spdep)
telldel <- tri2nb(coords = tellpoints@coords)

distmat <- gDistance(tellpoints, byid = TRUE)
distmat <- distmat / 1000

for (i in 1:dim(distmat)[1]) {
  distmat[i,-c(telldel[[i]])] <- NA
  }
```	

## Interaction 

```{r moin1}
library(moin)

int_mod <- sc(Oi = rep(x = 10, times = length(tellpoints)),
              Dj = rep(x = 5, times = length(tellpoints)),
              cij = distmat,
              beta = 1,
              detfun = "power")
tellpoints@data$si <- int_mod$si

mapview(tellpoints,
        cex = tellpoints$si,
        zcol = "si")  
```

## Network measures as attributes for Interaction

```{r netw}
g <- igraph::graph_from_adj_list(adjlist = telldel,
                                 mode = "all")
tellpoints@data$degree <- igraph::degree(g)
tellpoints@data$closeness <- igraph::closeness(g)
tellpoints@data$betweeness <- igraph::betweenness(g)

int_mod <- sc(Oi = rep(x = 10, times = length(tellpoints)),
              Dj = tellpoints@data$degree,
              cij = distmat,
              beta = 1,
              detfun = "power"
              )
tellpoints@data$si <- int_mod$si

mapview(tellpoints,
        cex = tellpoints$si,
        zcol = "si")
```

### What is the influence of different beta values on the location importance of sites?

First, let us have a look at changing $\beta$ values for the power function

```{r tests, fig.height = 10}
beta_test <- data.frame(beta = 0,
                        si = 0,
                        degree = 0
                        )
beta_seq <- seq(from = 0.1, to = 2.0, by = .1)

for (i in 1:length(beta_seq)) {
  j <- beta_seq[i]
  beta_test <- rbind(beta_test, data.frame(beta = rep(j, length(tellpoints)),
                                           si = sc(Oi = rep(x = 10, times = length(tellpoints)),
                                                   Dj = tellpoints@data$degree,
                                                   cij = distmat,
                                                   beta = j,
                                                   detfun = "power"
                                                   )$si,
                                           degree = tellpoints$degree)
                     )
}
beta_test <- beta_test[2:length(beta_test[,1]),]
head(beta_test)

beta_test2 <- beta_test %>%
  dplyr::as.tbl()

library(ggplot2)
ggplot(beta_test2, aes(x = si, y = as.factor(beta), fill = as.factor(degree))) + 
  ggjoy::geom_joy(scale = 2.5, rel_min_height=.01, alpha = .8, color = "white") +
  ggjoy::theme_joy() +
  theme(legend.position = "bottom") +
  viridis::scale_fill_viridis(discrete=TRUE,
                              name = "Degree centrality") +
  labs(x = "si",
       y = expression(paste(beta," factor of power function")),
       title = "Location attractiveness (si) in relation to degree-centrality and distance weight (beta) factors",
       subtitle = "Connections based on Delaunay graph; Origins weighted equally; attractiveness equals degree centrality",
       caption = "Data source: settlements in Harran OvasÄ±, SE Turkey, digitized from Corona satellite images (acquisition dates ~1960-1970)") +   
  guides(fill=guide_legend(nrow = 1))
```

### Colophon

This report was generated on `r Sys.time()` using the following computational environment and dependencies: 

```{r colophon, cache = FALSE}
# which R packages and versions?
devtools::session_info()
 
# what commit is this file at? You may need to change the path value
# if your Rmd is not in analysis/paper/
current_commit <- rrtools::current_git_commit(path = "../..")
```

The current git commit of this file is `r current_commit$sha`, which is on the `r current_commit$branch` branch and was made by `r current_commit$person` on `r current_commit$commit_date`. The current commit message is "`r current_commit$commit_msg`". The repository is online at <`r current_commit$remote_url`>



